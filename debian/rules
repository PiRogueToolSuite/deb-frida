#! /usr/bin/make -f

DEB_HOST_MULTIARCH := $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

# We only target arm64 and armhf; thankfully both frida and dpkg
# agree on their name:
FRIDA_ARCH := $(shell dpkg --print-architecture)
PYTHON     := python-linux-$(FRIDA_ARCH)
TOOLS      := tools-linux-$(FRIDA_ARCH)
DIR        := build/frida_thin-linux-$(FRIDA_ARCH)

export PYBUILD_NAME=frida
%:
	dh $@ --with python3 --buildsystem=none

override_dh_auto_build:
	$(MAKE) $(PYTHON)
	$(MAKE) $(TOOLS)

override_dh_auto_install:
	mkdir -p debian/frida/usr
	cp -r $(DIR)/* debian/frida/usr
	mkdir -p debian/frida/usr/lib/$(DEB_HOST_MULTIARCH)
	mv debian/frida/usr/lib/pkgconfig debian/frida/usr/lib/$(DEB_HOST_MULTIARCH)

override_dh_python3:
	dh_python3 --no-ext-rename

override_dh_clean:
	$(MAKE) clean
	dh_clean build/
